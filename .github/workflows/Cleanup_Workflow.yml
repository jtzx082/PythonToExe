name: Cleanup Workflow (Local)

# ä»…å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œé˜²æ­¢æ„å¤–è¿è¡Œ
on:
  workflow_dispatch:

permissions:
  contents: write  # ç”¨äºåˆ é™¤ Releases å’Œ Tags
  actions: write   # ç”¨äºåˆ é™¤ Workflow è¿è¡Œè®°å½•

jobs:
  cleanup-everything:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # 1. æ¸…ç†æ‰€æœ‰å·²ç»å®Œæˆçš„å·¥ä½œæµè¿è¡Œè®°å½•
      # ----------------------------------------------------------------
      - name: Delete all workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0       # ä¿ç•™ 0 å¤©ï¼ˆå³åˆ é™¤æ‰€æœ‰ï¼‰
          keep_minimum_runs: 0 # ä¿ç•™ 0 ä¸ªè®°å½•

      # ----------------------------------------------------------------
      # 2. æ¸…ç†æ‰€æœ‰ Releases å’Œ Tags
      # ----------------------------------------------------------------
      - name: Delete all Releases and Tags
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching list of releases..."
          # è·å–æœ€å¤š 1000 ä¸ª Release çš„ tag åç§°
          releases=$(gh release list --limit 1000 --json tagName --jq '.[].tagName')

          if [ -z "$releases" ]; then
            echo "No releases found to delete."
          else
            echo "Found releases. Deleting..."
            for tag in $releases; do
              echo "Deleting release and tag: $tag"
              # --cleanup-tag å‚æ•°ä¼šåœ¨åˆ é™¤ Release çš„åŒæ—¶åˆ é™¤å¯¹åº”çš„ Git Tag
              gh release delete "$tag" --cleanup-tag -y || true
            done
            echo "All releases and tags deleted."
          fi

      # ----------------------------------------------------------------
      # 3. [æ–°å¢] å¼ºåˆ¶æ¸…ç†æœ¬åœ°å®¿ä¸»æœºæ®‹ç•™æ–‡ä»¶ (è§£å†³ Permission denied)
      # ----------------------------------------------------------------
      - name: Force Cleanup Local Cache & Workspace
        run: |
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†æœ¬åœ°æ®‹ç•™æ–‡ä»¶..."
          
          # ä½¿ç”¨ sudo å¼ºåˆ¶åˆ é™¤ç”± Docker (Root) åˆ›å»ºçš„æ–‡ä»¶
          # è¿™ä¸€æ­¥æ˜¯è§£å†³ "æƒé™ä¸å¤Ÿ" æŠ¥é”™çš„å…³é”®
          
          if [ -d "openwrt_cache" ]; then
            echo "æ­£åœ¨åˆ é™¤ openwrt_cache..."
            sudo rm -rf openwrt_cache
          fi
          
          if [ -d "release_files" ]; then
             echo "æ­£åœ¨åˆ é™¤ release_files..."
             sudo rm -rf release_files
          fi
          
          if [ -d "workspace" ]; then
             echo "æ­£åœ¨åˆ é™¤ workspace..."
             sudo rm -rf workspace
          fi
          
          if [ -d "ib" ]; then
             echo "æ­£åœ¨åˆ é™¤ ib (ImageBuilderç›®å½•)..."
             sudo rm -rf ib
          fi
          
          echo "âœ… æœ¬åœ°æ–‡ä»¶æ¸…ç†å®Œæ¯•ï¼"
