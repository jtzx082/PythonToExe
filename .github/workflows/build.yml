name: Build Scientific Calculator

on:
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to use'
        required: true
        default: '3.10'
        type: choice
        options:
          - '3.8'
          - '3.9'
          - '3.10'
          - '3.11'
      target-platforms:
        description: 'Select platforms to build for'
        required: true
        default: 'windows,linux,macos'
        type: choice
        options:
          - 'windows'
          - 'linux'
          - 'macos'
          - 'windows,linux'
          - 'windows,macos'
          - 'linux,macos'
          - 'windows,linux,macos'
      build-type:
        description: 'Build type'
        required: true
        default: 'onefile'
        type: choice
        options:
          - 'onefile'
          - 'onedir'

env:
  PROJECT_NAME: "ScientificCalculator"
  MAIN_FILE: "scientific_calculator.py"

jobs:
  # Windows æž„å»ºä½œä¸š
  build-windows:
    runs-on: windows-latest
    name: Build for Windows
    if: contains(github.event.inputs.target-platforms, 'windows')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ github.event.inputs.python-version || '3.10' }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ github.event.inputs.python-version || '3.10' }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install pywin32
    
    - name: Build with PyInstaller
      run: |
        $BUILD_TYPE = "${{ github.event.inputs.build-type || 'onefile' }}"
        
        if ($BUILD_TYPE -eq "onefile") {
          pyinstaller --onefile --windowed --name=${{ env.PROJECT_NAME }} --clean ${{ env.MAIN_FILE }}
        } else {
          pyinstaller --windowed --name=${{ env.PROJECT_NAME }} --clean ${{ env.MAIN_FILE }}
        }
        
        # éªŒè¯æž„å»ºæ˜¯å¦æˆåŠŸ
        if (Test-Path "dist\${{ env.PROJECT_NAME }}.exe") {
          $fileInfo = Get-Item "dist\${{ env.PROJECT_NAME }}.exe"
          $fileSize = [math]::Round($fileInfo.Length / 1MB, 2)
          echo "Build successful! File size: ${fileSize}MB"
        } else {
          echo "::error::Build failed! Executable not found."
          exit 1
        }
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-windows
        path: |
          dist/${{ env.PROJECT_NAME }}.exe
          dist/${{ env.PROJECT_NAME }}/**/*  # for onedir mode
        retention-days: 7
  
  # Linux æž„å»ºä½œä¸š
  build-linux:
    runs-on: ubuntu-latest
    name: Build for Linux
    if: contains(github.event.inputs.target-platforms, 'linux')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ github.event.inputs.python-version || '3.10' }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ github.event.inputs.python-version || '3.10' }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        BUILD_TYPE="${{ github.event.inputs.build-type || 'onefile' }}"
        
        if [ "$BUILD_TYPE" = "onefile" ]; then
          pyinstaller --onefile --name=${{ env.PROJECT_NAME }} --clean ${{ env.MAIN_FILE }}
        else
          pyinstaller --name=${{ env.PROJECT_NAME }} --clean ${{ env.MAIN_FILE }}
        fi
        
        # éªŒè¯æž„å»ºæ˜¯å¦æˆåŠŸ
        if [ -f "dist/${{ env.PROJECT_NAME }}" ]; then
          fileSize=$(($(stat -c%s "dist/${{ env.PROJECT_NAME }}") / 1024 / 1024))
          echo "Build successful! File size: ${fileSize}MB"
        else
          echo "::error::Build failed! Executable not found."
          exit 1
        fi
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-linux
        path: |
          dist/${{ env.PROJECT_NAME }}
          dist/${{ env.PROJECT_NAME }}/**/*  # for onedir mode
        retention-days: 7
  
  # macOS æž„å»ºä½œä¸š
  build-macos:
    runs-on: macos-latest
    name: Build for macOS
    if: contains(github.event.inputs.target-platforms, 'macos')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ github.event.inputs.python-version || '3.10' }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ github.event.inputs.python-version || '3.10' }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        BUILD_TYPE="${{ github.event.inputs.build-type || 'onefile' }}"
        
        if [ "$BUILD_TYPE" = "onefile" ]; then
          pyinstaller --onefile --name=${{ env.PROJECT_NAME }} --clean ${{ env.MAIN_FILE }}
        else
          pyinstaller --name=${{ env.PROJECT_NAME }} --clean ${{ env.MAIN_FILE }}
        fi
        
        # éªŒè¯æž„å»ºæ˜¯å¦æˆåŠŸ
        if [ -f "dist/${{ env.PROJECT_NAME }}" ]; then
          fileSize=$(($(stat -f%z "dist/${{ env.PROJECT_NAME }}") / 1024 / 1024))
          echo "Build successful! File size: ${fileSize}MB"
        else
          echo "::error::Build failed! Executable not found."
          exit 1
        fi
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-macos
        path: |
          dist/${{ env.PROJECT_NAME }}
          dist/${{ env.PROJECT_NAME }}/**/*  # for onedir mode
        retention-days: 7
  
  # æ±‡æ€»æŠ¥å‘Šä½œä¸š
  summary:
    runs-on: ubuntu-latest
    name: Build Summary
    needs: [build-windows, build-linux, build-macos]
    if: always()
    
    steps:
    - name: Create build summary
      run: |
        echo "# ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ”§ Build Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version:** ${{ github.event.inputs.python-version || '3.10' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Platforms:** ${{ github.event.inputs.target-platforms || 'windows,linux,macos' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type:** ${{ github.event.inputs.build-type || 'onefile' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“Š Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Windows çŠ¶æ€
        if contains(github.event.inputs.target-platforms, 'windows'); then
          echo "| ðŸªŸ Windows | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Linux çŠ¶æ€
        if contains(github.event.inputs.target-platforms, 'linux'); then
          echo "| ðŸ§ Linux | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # macOS çŠ¶æ€
        if contains(github.event.inputs.target-platforms, 'macos'); then
          echo "| ðŸŽ macOS | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "You can download the built executables from the Artifacts section above:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if contains(github.event.inputs.target-platforms, 'windows'); then
          echo "- **${{ env.PROJECT_NAME }}-windows**: Windows executable (.exe)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if contains(github.event.inputs.target-platforms, 'linux'); then
          echo "- **${{ env.PROJECT_NAME }}-linux**: Linux executable" >> $GITHUB_STEP_SUMMARY
        fi
        
        if contains(github.event.inputs.target-platforms, 'macos'); then
          echo "- **${{ env.PROJECT_NAME }}-macos**: macOS executable" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ Usage Notes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Windows**: Run the `.exe` file directly" >> $GITHUB_STEP_SUMMARY
        echo "2. **Linux**: Make the file executable first: `chmod +x ScientificCalculator`" >> $GITHUB_STEP_SUMMARY
        echo "3. **macOS**: The app may need to be granted permission in Security & Privacy settings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Build completed at: $(date)*" >> $GITHUB_STEP_SUMMARY
