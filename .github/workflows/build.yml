name: Build Scientific Calculator

on:
  # 允许手动触发工作流
  workflow_dispatch:
    # 可选的输入参数
    inputs:
      python-version:
        description: 'Python version to use'
        required: true
        default: '3.10'
        type: choice
        options:
        - '3.8'
        - '3.9'
        - '3.10'
        - '3.11'
      build-type:
        description: 'Build type'
        required: true
        default: 'onefile'
        type: choice
        options:
        - 'onefile'
        - 'onedir'
      include-icon:
        description: 'Include icon'
        required: true
        default: 'true'
        type: boolean
      upload-release:
        description: 'Upload to release'
        required: false
        default: 'false'
        type: boolean

  # 也可以在推送标签时自动构建（可选）
  push:
    tags:
      - 'v*'

  # 或者在创建release时自动构建（可选）
  release:
    types: [created]

# 设置环境变量
env:
  PROJECT_NAME: "ScientificCalculator"
  MAIN_FILE: "scientific_calculator.py"

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build for Windows (${{ matrix.python-version }})
    
    # 设置策略，可以同时构建多个Python版本
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
      # 如果手动指定了Python版本，则只构建指定版本
      ${{ github.event_name == 'workflow_dispatch' && format('
        matrix: 
          python-version: ["{0}"]', inputs.python-version) || '' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install pywin32
    
    - name: Display Python and PyInstaller info
      run: |
        python --version
        pyinstaller --version
    
    - name: Prepare build directory
      run: |
        mkdir -p build
        mkdir -p dist
    
    - name: Build with PyInstaller
      id: build
      run: |
        # 构建命令根据输入参数动态生成
        $BUILD_CMD = "pyinstaller"
        
        # 根据构建类型添加参数
        ${{ github.event_name == 'workflow_dispatch' && inputs.build-type == 'onedir' && format('
        $BUILD_CMD = "$BUILD_CMD"') || '
        $BUILD_CMD = "$BUILD_CMD --onefile"' }}
        
        # 添加无控制台窗口参数
        $BUILD_CMD = "$BUILD_CMD --windowed"
        
        # 设置程序名称
        $BUILD_CMD = "$BUILD_CMD --name $env:PROJECT_NAME"
        
        # 如果包含图标且图标文件存在
        ${{ github.event_name == 'workflow_dispatch' && inputs.include-icon == 'true' && format('
        if (Test-Path "icon.ico") {{
          $BUILD_CMD = "$BUILD_CMD --icon=icon.ico"
        }}') || '
        if (Test-Path "icon.ico") {
          $BUILD_CMD = "$BUILD_CMD --icon=icon.ico"
        }' }}
        
        # 添加清理和优化参数
        $BUILD_CMD = "$BUILD_CMD --clean"
        
        # 添加主程序文件
        $BUILD_CMD = "$BUILD_CMD $env:MAIN_FILE"
        
        # 显示构建命令
        echo "Build command: $BUILD_CMD"
        
        # 执行构建
        Invoke-Expression $BUILD_CMD
        
        # 验证构建是否成功
        if (Test-Path "dist\$env:PROJECT_NAME.exe") {
          # 获取文件大小
          $fileInfo = Get-Item "dist\$env:PROJECT_NAME.exe"
          $fileSize = [math]::Round($fileInfo.Length / 1MB, 2)
          echo "::set-output name=file_size::$fileSize"
          echo "Build successful! File size: ${fileSize}MB"
        } else {
          echo "::error::Build failed! Executable not found."
          exit 1
        }
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.PROJECT_NAME }}-windows-py${{ matrix.python-version }}
        path: dist/${{ env.PROJECT_NAME }}.exe
    
    - name: Upload to release (if tag exists)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/${{ env.PROJECT_NAME }}.exe
        prerelease: false
  
  # 可选的第二个任务：构建macOS版本
  build-macos:
    runs-on: macos-latest
    name: Build for macOS
    needs: build-windows  # 依赖Windows构建完成
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build for macOS
      run: |
        pyinstaller --onefile --windowed --name=${{ env.PROJECT_NAME }} ${{ env.MAIN_FILE }}
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.PROJECT_NAME }}-macos
        path: dist/${{ env.PROJECT_NAME }}
  
  # 可选的第三个任务：构建Linux版本
  build-linux:
    runs-on: ubuntu-latest
    name: Build for Linux
    needs: build-windows  # 依赖Windows构建完成
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build for Linux
      run: |
        pyinstaller --onefile --name=${{ env.PROJECT_NAME }} ${{ env.MAIN_FILE }}
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.PROJECT_NAME }}-linux
        path: dist/${{ env.PROJECT_NAME }}
  
  # 汇总任务：创建汇总报告
  summary:
    runs-on: ubuntu-latest
    name: Build Summary
    needs: [build-windows]  # 只需要等待Windows构建完成
    if: always()  # 即使前面的任务失败也运行
    
    steps:
    - name: Create build summary
      run: |
        echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # 检查各个构建任务的状态
        echo "| Platform | Status | Python Version |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|----------------|" >> $GITHUB_STEP_SUMMARY
        
        ${{ matrix.python-version && format('
        echo "| Windows | {0} | {1} |" >> $GITHUB_STEP_SUMMARY', needs.build-windows.result, matrix.python-version) || '' }}
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "You can download the built executable from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Python Version: ${{ inputs.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Type: ${{ inputs.build-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Include Icon: ${{ inputs.include-icon }}" >> $GITHUB_STEP_SUMMARY
        fi
