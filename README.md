# AI 写作助手 - 公文格式优化说明

## 优化内容

根据《公文处理主要格式规范》，对 `save_as_docx` 函数进行了全面优化，实现标准公文排版格式。

### 1. 页面格式设置
- **纸张规格**：A4 纸（210mm × 297mm）
- **页边距**：
  - 上边距：37mm
  - 下边距：35mm
  - 左边距：28mm
  - 右边距：26mm

### 2. 标题格式优化
- **字体**：2号小标宋体（22磅）
- **对齐**：居中
- **关键改进**：✅ **去除了标题下划线**（原代码使用 `add_heading` 会自动添加下划线）
- **间距**：标题后空两行

### 3. 正文格式规范
- **基础字体**：3号仿宋（16磅）
- **行间距**：固定值28磅

### 4. 公文层级结构识别
根据公文规范，新增了对以下层级标题的自动识别和格式设置：

| 层级 | 标识格式 | 字体 | 字号 |
|------|---------|------|------|
| 第一层 | 一、二、三、... | 3号黑体（加粗） | 16磅 |
| 第二层 | （一）（二）（三）... | 3号楷体 | 16磅 |
| 第三层 | 1. 2. 3. ... | 3号仿宋 | 16磅 |
| 第四层 | （1）（2）（3）... | 3号仿宋 | 16磅 |

### 5. Markdown 标题兼容
对于 Markdown 格式的标题（# ## ###），保持兼容：
- **一级标题**（#）：3号黑体（加粗）
- **其他标题**：3号仿宋（加粗）

## 新增辅助函数

### 1. `_match_official_heading(text)`
识别公文标准层级标题格式，返回 `(level, heading_text)` 或 `None`

### 2. `_set_run_format(run, font_name, font_size, bold)`
设置文本运行的字体格式，确保中文字体正确显示

### 3. `_set_paragraph_format(paragraph, font_name, font_size)`
设置段落格式，统一应用28磅固定行距

## 使用建议

1. **公文写作**：软件会自动识别标准公文层级，建议使用：
   ```
   一、总体要求
   （一）指导思想
   1. 具体措施
   （1）详细内容
   ```

2. **Markdown 兼容**：也可以继续使用 Markdown 格式：
   ```markdown
   # 一级标题
   ## 二级标题
   ### 三级标题
   ```

3. **混合使用**：两种格式可以在同一文档中混用

## 技术细节

- 使用 `python-docx` 库的底层 API 实现精确的字体和段落控制
- 通过 `qn('w:eastAsia')` 确保中文字体（仿宋、黑体、楷体）正确应用
- 标题不再使用 `add_heading`，改为手动创建段落并设置格式，避免自动下划线

## 注意事项

- 如果系统中没有安装小标宋、仿宋、黑体、楷体字体，Word 会自动使用相近字体替代
- Windows 系统通常内置这些字体
- macOS/Linux 用户可能需要安装 Windows 字体包或使用替代字体

## 版本信息

- 优化日期：2026年2月12日
- 基于文件：W020190522382998195358.docx（公文处理主要格式规范）
- 优化者：Claude (Anthropic)
